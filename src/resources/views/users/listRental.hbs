<!-- Page Content -->
<div class="container mt-4">
    <div class="latest">
        <div class="caption">
            <a href="#">
                <span><i class="fas fa-star"></i></span>
                "Danh sách truyện cho thuê"
            </a>
        </div>
        {{#each rentals}}
            <ul class="list-manga grid-6">
                {{#each this.books}}
                    <li>
                        <div class="manga-item">
                            <a href="/manga/{{this.slug}}"> <img src="/img/{{this.image}}" alt="#"></a>
                            <h4 class="title-book">
                                <p href="#">Tên Truyện: {{this.nameManga}}</p>   
                            </h4>
                            <p href="#">Tập số: {{this.episode}}, Giá thuê {{this.rentCost}},Số lượng <span class="amount">{{this.amount}}</span>  </p>
                            <div class="chapter-book" data-id="{{this._id}}">
                                {{!-- handlebars helper --}}
                                {{!-- nếu số lượng = 0 => hết hàng, ngược lại => addToCart --}}
                                {{#if_eq this.amount}}
                                {{/if_eq}}
                            </div>
                            <div class="more-info"></div>
                        </div>
                    </li>
                {{/each}}
            </ul>
        {{/each}}
    </div>
</div>
<div class="container">
    <div class="latest">
        <div class="caption">
            <a href="#">
                <span><i class="fas fa-star"></i></span>
                "Caption Something"
            </a>
        </div>
        <ul class="list-manga grid-6">
            {{#rentals}}
                <li>
                    <div class="manga-item">
                        <a href="/manga/{{slug}}"> <img src="/img/{{image}}" alt="#"></a>
                        <h4 class="title-book">
                            <p href="#">Tên Truyện: {{nameManga}}</p>
                        </h4>
                        <p href="#">Tổng số tập:{{books.length}}</p>
                    </div>
                </li>
            {{/rentals}}
        </ul>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded",()=>{
        var btnAddToCarts = document.querySelectorAll(".btn-add-to-cart")
        var cartItem = document.querySelector('.cart-item')
        var amount = document.querySelectorAll('.amount')
        var flag = 1
        btnAddToCarts.forEach((btn, i) => {
            btn.onclick = function(e) {
                e.preventDefault();
                var idBook = this.parentElement.getAttribute("data-id")
                console.log(idBook)
                console.log("amount : ",amount[i].innerText)
                if(amount[i].innerText <= 0){
                    alert("Hết hàng!")
                    flag = 0
                }
                if(flag == 1){    
                    axios.post('/addToCart/'+ idBook)
                    .then((res)=>{
                        console.log(res.data)
                        if(res.data.message == 'Tập truyện này đã có trong giỏ hàng!'){
                            alert(res.data.message)
                        }
                        if(res.data.message == 'Thêm vào giỏ hàng thành công'){
                            alert(res.data.message)
                            const totalItem = res.data.user.cart.totalItem
                            cartItem.innerText = totalItem
                        }
                    })
                    .catch((err)=>{
                        console.log(err)
                    })
                }
            }
        })
    })
</script>